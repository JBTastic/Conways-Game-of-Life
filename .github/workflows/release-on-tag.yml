name: Build and Release on Tag

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install SDL2
              run: sudo apt-get update && sudo apt-get install -y libsdl2-dev libsdl2-ttf-dev libsdl2-image-dev zip tar
            - name: Build binary and create archive
              run: |
                  BIN_NAME="conways-game-of-life"
                  g++ -std=c++17 *.cpp -o "$BIN_NAME" -lSDL2 -lSDL2_ttf -lSDL2_image
                  chmod +x "$BIN_NAME"
                  tar -czf "conways-game-of-life-linux-amd64.tar.gz" "$BIN_NAME"
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: conways-game-of-life-linux-amd64
                  path: conways-game-of-life-linux-amd64.tar.gz

    build-windows:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install MinGW
              run: sudo apt-get update && sudo apt-get install -y g++-mingw-w64-x86-64 zip
            - name: Build binary and create archive
              run: |
                  BIN_NAME="conways-game-of-life.exe"
                  x86_64-w64-mingw32-g++ -std=c++17 *.cpp -o "$BIN_NAME"
                  zip "conways-game-of-life-windows-amd64.zip" "$BIN_NAME"
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: conways-game-of-life-windows-amd64
                  path: conways-game-of-life-windows-amd64.zip

    build-macos:
        runs-on: macos-latest
        strategy:
            matrix:
                arch: [amd64, arm64]
        steps:
            - uses: actions/checkout@v4
            - name: Build binary and create archive
              run: |
                  BIN_NAME="conways-game-of-life"
                  clang++ -std=c++17 -arch ${{ matrix.arch }} *.cpp -o "$BIN_NAME"
                  chmod +x "$BIN_NAME"
                  tar -czf "conways-game-of-life-darwin-${{ matrix.arch }}.tar.gz" "$BIN_NAME"
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: conways-game-of-life-darwin-${{ matrix.arch }}
                  path: conways-game-of-life-darwin-${{ matrix.arch }}.tar.gz

    release:
        needs: [build-linux, build-windows, build-macos]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts
            - name: Create GitHub Release
              id: create_release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Upload release assets
              run: |
                  for dir in ./artifacts/*; do
                    file=$(find "$dir" -type f | head -n 1)
                    echo "Uploading $file"
                    gh release upload ${{ github.ref_name }} "$file"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
