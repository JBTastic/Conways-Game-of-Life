name: Build and Release on Tag

on:
    push:
        tags:
            - "v*.*.*" # reacts to tags like v1.0.0, v2.1.3, etc.

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                include:
                    - os: linux
                      arch: amd64
                      ext: ""
                    - os: windows
                      arch: amd64
                      ext: ".exe"
                    - os: darwin
                      arch: amd64
                      ext: ""
                    - os: darwin
                      arch: arm64
                      ext: ""

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install zip and tar
              run: sudo apt-get update && sudo apt-get install -y zip tar

            - name: Install g++ cross-compilers
              run: |
                  if [[ "${{ matrix.os }}" == "windows" ]]; then
                    sudo apt-get install -y g++-mingw-w64-x86-64
                  elif [[ "${{ matrix.os }}" == "darwin" ]]; then
                    sudo apt-get install -y clang
                  fi

            - name: Build binary and create archive
              run: |
                  BIN_NAME="conways-game-of-life${{ matrix.ext }}"

                  # Determine compiler and flags
                  if [[ "${{ matrix.os }}" == "linux" ]]; then
                    g++ -std=c++17 *.cpp -o "$BIN_NAME" -lSDL2 -lSDL2_ttf -lSDL2_image
                  elif [[ "${{ matrix.os }}" == "windows" ]]; then
                    x86_64-w64-mingw32-g++ -std=c++17 *.cpp -o "$BIN_NAME" -lSDL2 -lSDL2_ttf -lSDL2_image
                  elif [[ "${{ matrix.os }}" == "darwin" ]]; then
                    if [[ "${{ matrix.arch }}" == "amd64" ]]; then
                      clang++ -std=c++17 -arch x86_64 *.cpp -o "$BIN_NAME" -lSDL2 -lSDL2_ttf -lSDL2_image
                    elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
                      clang++ -std=c++17 -arch arm64 *.cpp -o "$BIN_NAME" -lSDL2 -lSDL2_ttf -lSDL2_image
                    fi
                  fi

                  chmod +x "$BIN_NAME" || true

                  # Archive name
                  ARCHIVE_NAME="conways-game-of-life-${{ matrix.os }}-${{ matrix.arch }}"

                  if [[ "${{ matrix.os }}" == "linux" || "${{ matrix.os }}" == "darwin" ]]; then
                    tar -czf "${ARCHIVE_NAME}.tar.gz" "$BIN_NAME"
                  elif [[ "${{ matrix.os }}" == "windows" ]]; then
                    zip "${ARCHIVE_NAME}.zip" "$BIN_NAME"
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: conways-game-of-life-${{ matrix.os }}-${{ matrix.arch }}
                  path: |
                      conways-game-of-life-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
                      conways-game-of-life-${{ matrix.os }}-${{ matrix.arch }}.zip

    release:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Create GitHub Release
              id: create_release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload release assets
              run: |
                  for dir in ./artifacts/*; do
                    file=$(find "$dir" -type f | head -n 1)
                    echo "Uploading $file"
                    gh release upload ${{ github.ref_name }} "$file"
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
